<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<html>
<head>
    <title>Admin Portal</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav>
        <div class="nav-container">
            <a href="voting.html" class="nav-logo">SNU Recruit</a>
            <button class="hamburger" aria-label="Menu">
                <span class="hamburger-box">
                    <span class="hamburger-inner"></span>
                </span>
            </button>
            <div class="nav-links nav-menu">
                <a href="index.html">Admin</a>
                <a href="gallery.html">Gallery</a>
                <a href="voting.html">Voting</a>
            </div>
        </div>
    </nav>
    <div class="admin-container">
        <div class="form-card">
            <h1 class="form-title">Add New PNM</h1>
            <form id="pnmForm">
                <div class="form-group">
                    <label for="name">Full Name</label>
                    <input type="text" id="name" required>
                </div>
                
                <div class="form-group">
                    <label for="number">PNM Number</label>
                    <input type="number" id="number" required>
                </div>

                <div class="form-group">
                    <label for="gpa">GPA</label>
                    <input type="number" step="0.01" id="gpa" required>
                </div>

                <div class="form-group">
                    <label class="file-upload">
                        <input type="file" id="photo" accept="image/*">
                        <span class="upload-label">Upload Photo</span>
                        <span class="file-name" id="fileName">No file chosen</span>
                    </label>
                </div>

                <button type="submit" class="submit-btn">
                    <span>Add PNM</span>
                    <svg viewBox="0 0 24 24" width="20" height="20">
                        <path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" />
                    </svg>
                </button>
            </form>
            <div class="pnm-list">
                <h2>Current PNMs (<span id="pnmCount">0</span>)</h2>
                <div class="stats">
                    <span>Total: <span id="totalPnms">0</span></span>
                    <span>Avg GPA: <span id="avgGpa">0.0</span></span>
                </div>
                <div class="pnm-grid" id="adminPnmList"></div>
            </div>
        </div>
        <button onclick="clearStorage()" class="clear-btn">Clear All</button>
    </div>

    <script>
        let isProcessing = false;
        // Image compression function
        function compressImage(file, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800;
                    const MAX_HEIGHT = 800;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    canvas.toBlob(blob => {
                        const reader = new FileReader();
                        reader.onloadend = () => callback(reader.result);
                        reader.readAsDataURL(blob);
                    }, 'image/jpeg', 0.7);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    
        // Form submission handler
        document.getElementById('pnmForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const submitBtn = this.querySelector('button[type="submit"]');
            const editId = this.dataset.editId;

            if (isProcessing) return;

            // Validate form inputs
            const name = document.getElementById('name').value.trim();
            const number = document.getElementById('number').value;
            const gpa = document.getElementById('gpa').value;
            const file = document.getElementById('photo').files[0];

            // Check for required fields
            if (!name || !number || !gpa) {
                alert('Name, PNM Number, and GPA are required!');
                return;
            }

            // Validate GPA
            if (isNaN(gpa) || parseFloat(gpa) > 5.0 || parseFloat(gpa) < 0) {
                alert('Please enter a valid GPA between 0-5.0');
                return;
            }

            // Only require an image if adding a new PNM
            if (!editId && !file) {
                alert('Please upload a photo for the new PNM.');
                return;
            }

            isProcessing = true;
            submitBtn.disabled = true;
            submitBtn.querySelector('span').textContent = editId ? 'Updating...' : 'Adding...';

            const processPNM = (compressedPhoto) => {
                const pnms = JSON.parse(localStorage.getItem('pnms')) || [];
                
                if (editId) {
                    // Update existing PNM
                    const index = pnms.findIndex(p => p.id == editId);
                    if (index === -1) return;
                    
                    pnms[index] = {
                        ...pnms[index],
                        name: name,
                        number: number,
                        gpa: gpa,
                        photo: compressedPhoto || this.dataset.existingPhoto // Use existing photo if no new one is provided
                    };
                } else {
                    // Create new PNM
                    pnms.push({
                        id: Date.now(),
                        name: name,
                        number: number,
                        gpa: gpa,
                        photo: compressedPhoto,
                        comments: [],
                        bidStatus: null
                    });
                }

                localStorage.setItem('pnms', JSON.stringify(pnms));
                this.reset();
                document.getElementById('fileName').textContent = 'No file chosen';
                resetFormState(submitBtn);
                delete this.dataset.editId;
                delete this.dataset.existingPhoto; // Clear the stored photo URL
                submitBtn.querySelector('span').textContent = 'Add PNM';
                renderAdminList();
                alert(editId ? 'PNM updated successfully!' : 'PNM added successfully!');
            };

            if (file) {
                // Compress and process the new image
                compressImage(file, processPNM);
            } else if (editId) {
                // No new image provided, use the existing one
                processPNM(null);
            }
        });
    
        // Clear storage function
        function clearStorage() {
            if (confirm('Are you sure you want to delete ALL data? This cannot be undone!')) {
                localStorage.clear();
                alert('All data has been cleared!');
                location.reload();
            }
        }
    
        // File input handler
        document.getElementById('photo').addEventListener('change', function(e) {
            document.getElementById('fileName').textContent = 
                this.files[0]?.name || 'No file chosen';
        });
    
        // Helper function to reset form state
        function resetFormState(submitBtn) {
            isProcessing = false;
            submitBtn.disabled = false;
        }
    
        // PNM List Management Functions
        function renderAdminList() {
            const container = document.getElementById('adminPnmList');
            const pnms = JSON.parse(localStorage.getItem('pnms')) || [];
            // Update the PNM count
            document.getElementById('pnmCount').textContent = pnms.length;
            container.innerHTML = pnms.map(pnm => `
                <div class="pnm-item" data-id="${pnm.id}">
                    <div class="pnm-actions">
                        <button class="edit-btn" onclick="openEditForm('${pnm.id}')">‚úèÔ∏è</button>
                        <button class="delete-btn" onclick="deletePnm('${pnm.id}')">üóëÔ∏è</button>
                    </div>
                    <img src="${pnm.photo}" class="admin-thumb" alt="${pnm.name}">
                    <h4>${pnm.name}</h4>
                    <p>#${pnm.number} | GPA: ${pnm.gpa}</p>
                    <p>Bid Status: ${pnm.bidStatus !== null ? 
                        (pnm.bidStatus ? '‚úÖ' : '‚ùå') : 'Pending'}</p>
                </div>
            `).join('');
            // Update stats
            document.getElementById('totalPnms').textContent = pnms.length;
            document.getElementById('avgGpa').textContent = pnms.length > 0 
                ? (pnms.reduce((sum, p) => sum + parseFloat(p.gpa), 0) / pnms.length).toFixed(2)
                : '0.00';
        }
    
        function deletePnm(id) {
            if (!confirm('Delete this PNM permanently?')) return;
            const pnms = JSON.parse(localStorage.getItem('pnms')) || [];
            const filtered = pnms.filter(p => p.id != id);
            localStorage.setItem('pnms', JSON.stringify(filtered));
            renderAdminList();
            alert('PNM deleted successfully!');
        }
    
        function openEditForm(id) {
            const pnms = JSON.parse(localStorage.getItem('pnms')) || [];
            const pnm = pnms.find(p => p.id == id);
            
            if (!pnm) return;
            
            // Populate form fields
            document.getElementById('name').value = pnm.name;
            document.getElementById('number').value = pnm.number;
            document.getElementById('gpa').value = pnm.gpa;
            
            // Clear the file input
            document.getElementById('photo').value = '';
            document.getElementById('fileName').textContent = 'Using existing photo';
            
            // Store the existing image URL
            const form = document.getElementById('pnmForm');
            form.dataset.editId = id;
            form.dataset.existingPhoto = pnm.photo; // Store the existing photo URL
            
            form.querySelector('button[type="submit"] span').textContent = 'Update PNM';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
            
        // Navigation toggle
        const hamburger = document.querySelector('.hamburger');
        const navMenu = document.querySelector('.nav-menu');
        hamburger.addEventListener('click', () => {
            hamburger.classList.toggle('active');
            navMenu.classList.toggle('active');
        });
    
        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!hamburger.contains(e.target) && !navMenu.contains(e.target)) {
                hamburger.classList.remove('active');
                navMenu.classList.remove('active');
            }
        });
    
        // Initial render
        document.addEventListener('DOMContentLoaded', renderAdminList);
    </script>

</body>
</html>