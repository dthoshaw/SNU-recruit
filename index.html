<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<html>
<head>
    <title>Admin Portal</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav>
        <div class="nav-container">
            <a href="voting.html" class="nav-logo">SNU Recruit</a>
            <button class="hamburger" aria-label="Menu">
                <span class="hamburger-box">
                    <span class="hamburger-inner"></span>
                </span>
            </button>
            <div class="nav-links nav-menu">
                <a href="index.html">Admin</a>
                <a href="gallery.html">Gallery</a>
                <a href="voting.html">Voting</a>
            </div>
        </div>
    </nav>
    <div class="admin-container">
        <div class="form-card">
            <h1 class="form-title">Add New PNM</h1>
            <form id="pnmForm">
                <div class="form-group">
                    <label for="name">Full Name</label>
                    <input type="text" id="name" required>
                </div>
                
                <div class="form-group">
                    <label for="number">PNM Number</label>
                    <input type="number" id="number" required>
                </div>

                <div class="form-group">
                    <label for="gpa">GPA</label>
                    <input type="number" step="0.01" id="gpa" required>
                </div>

                <div class="form-group">
                    <label class="file-upload">
                        <input type="file" id="photo" accept="image/*" required>
                        <span class="upload-label">Upload Photo</span>
                        <span class="file-name" id="fileName">No file chosen</span>
                    </label>
                </div>

                <button type="submit" class="submit-btn">
                    <span>Add PNM</span>
                    <svg viewBox="0 0 24 24" width="20" height="20">
                        <path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" />
                    </svg>
                </button>
            </form>
        </div>
        <button onclick="clearStorage()" class="clear-btn">Clear All</button>
    </div>



    <script>
        let isProcessing = false;
        // Image compression function
        function compressImage(file, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800;
                    const MAX_HEIGHT = 800;
                    let width = img.width;
                    let height = img.height;
                    // Calculate new dimensions while maintaining aspect ratio
                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);       
                    // Convert to JPEG with 70% quality
                    canvas.toBlob(blob => {
                        const reader = new FileReader();
                        reader.onloadend = () => callback(reader.result);
                        reader.readAsDataURL(blob);
                    }, 'image/jpeg', 0.7);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        // Form submission handler
        document.getElementById('pnmForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const submitBtn = this.querySelector('button[type="submit"]');     
            // Prevent multiple submissions
            if (isProcessing) return; 
            // Validate form inputs
            const name = document.getElementById('name').value.trim();
            const number = document.getElementById('number').value;
            const gpa = document.getElementById('gpa').value;
            const file = document.getElementById('photo').files[0];
            if (!name || !number || !gpa || !file) {
                alert('All fields are required!');
                return;
            }
            if (isNaN(gpa) || parseFloat(gpa) > 4.0 || parseFloat(gpa) < 0) {
                alert('Please enter a valid GPA between 0-4.0');
                return;
            }
            // Lock form during processing
            isProcessing = true;
            submitBtn.disabled = true;
            submitBtn.querySelector('span').textContent = 'Adding...';
            // Capture form data before async operation
            const formData = {
                name: name,
                number: number,
                gpa: gpa,
                file: file
            };
            // Process image and save data
            compressImage(formData.file, (compressedPhoto) => {
                // Final validation check
                if (!formData.name || !formData.number || !formData.gpa) {
                    alert('Form data was modified during processing!');
                    resetFormState(submitBtn);
                    return;
                }
                // Create PNM object
                const pnm = {
                    id: Date.now(),
                    name: formData.name,
                    number: formData.number,
                    gpa: formData.gpa,
                    photo: compressedPhoto,
                    comments: [],
                    bid: null
                };
                // Save to localStorage
                const pnms = JSON.parse(localStorage.getItem('pnms')) || [];
                pnms.push(pnm);
                localStorage.setItem('pnms', JSON.stringify(pnms));
                // Reset form state
                this.reset();
                document.getElementById('fileName').textContent = 'No file chosen';
                resetFormState(submitBtn);
                alert('PNM added successfully!');
            });
        });
        // Clear storage function
        function clearStorage() {
            if (confirm('Are you sure you want to delete ALL data? This cannot be undone!')) {
                localStorage.clear();
                alert('All data has been cleared!');
                location.reload();
            }
        }
        // File input handler
        document.getElementById('photo').addEventListener('change', function(e) {
            document.getElementById('fileName').textContent = 
                this.files[0]?.name || 'No file chosen';
        });
        // Helper function to reset form state
        function resetFormState(submitBtn) {
            isProcessing = false;
            submitBtn.disabled = false;
            submitBtn.querySelector('span').textContent = 'Add PNM';
        }
        const hamburger = document.querySelector('.hamburger');
        const navMenu = document.querySelector('.nav-menu');
        hamburger.addEventListener('click', () => {
            hamburger.classList.toggle('active');
            navMenu.classList.toggle('active');
        });
        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!hamburger.contains(e.target) && !navMenu.contains(e.target)) {
                hamburger.classList.remove('active');
                navMenu.classList.remove('active');
            }
        });
    </script>
</body>
</html>